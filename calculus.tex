% !TEX root = hazelnut-dynamics.tex

\clearpage
\newcommand{\calculusSec}{Hazelnut Live, Formally}
\section{\protect\calculusSec}
\label{sec:calculus}
\todo{exposition}

\begin{figure}[h]
$\arraycolsep=4pt\begin{array}{rllllll}
\mathsf{HTyp} & \htau & ::= &
  \tarr{\htau}{\htau} ~\vert~
  \tprod{\htau}{\htau} ~\vert~
  \tsum{\htau}{\htau} ~\vert~
  \tnum ~\vert~
  \tehole\\
\mathsf{HExp} & \hexp & ::= &
  x ~\vert~
  \halam{x}{\htau}{\hexp} ~\vert~
  \hap{\hexp}{\hexp} ~\vert~
  \hpair{\hexp}{\hexp} ~\vert~
  \hprj{i}{\hexp} ~\vert~
  \hinj{i}{\hexp} ~\vert~
  \hcase{\hexp}{x}{\hexp}{x}{\hexp} ~\vert~
  \hnum{n} ~\vert~
  \hadd{\hexp}{\hexp} ~\vert~
  \hehole{u} ~\vert~
  \hhole{\hexp}{u} ~\vert~
  {\hlam{x}{\hexp}} ~\vert~
  \hexp : \htau\\
 \mathsf{DHExp} & \dexp  & ::= &
  x ~\vert~
  {\halam{x}{\htau}{\dexp}} ~\vert~
  \hap{\dexp}{\dexp} ~\vert~
  \hpair{\dexp}{\dexp} ~\vert~
  \hprj{i}{\dexp} ~\vert~
  \hinj{i}{\dexp} ~\vert~
  \hcase{\dexp}{x}{\dexp}{x}{\dexp} ~\vert~
  \hnum{n} ~\vert~
  \hadd{\dexp}{\dexp} ~\vert~
  \dehole{\mvar}{\subst} ~\vert~
  \dhole{\dexp}{\mvar}{\subst}\\

\end{array}$
\caption{Syntax of H-types, H-expressions and dynamic H-expressions. We write $x$ to range over variables, $n$ over numbers, $i$ over labels in $\{\lblL, \lblR\}$, $u$ over hole names and $\sigma$ over finite substitutions.}
\label{fig:HTyp}
\label{fig:HExp}
\end{figure}

\begin{figure}[h]
\judgbox{\tconsistent{\htau_1}{\htau_2}}{$\htau_1$ is consistent with $\htau_2$}
\begin{mathpar}
\inferrule{ }{
  \tconsistent{\tehole}{\htau}
}

\inferrule{ }{
  \tconsistent{\htau}{\tehole}
}

\inferrule{ }{
  \tconsistent{\htau}{\htau}
}

\inferrule{
  \tconsistent{\htau_1}{\htau_1'}\\
  \tconsistent{\htau_2}{\htau_2'}
}{
  \tconsistent{\tarr{\htau_1}{\htau_2}}{\tarr{\htau_1'}{\htau_2'}}
}

\inferrule{
  \tconsistent{\htau_1}{\htau_1'}\\
  \tconsistent{\htau_2}{\htau_2'}
}{
  \tconsistent{\tprod{\htau_1}{\htau_2}}{\tprod{\htau_1'}{\htau_2'}}
}

\inferrule{
  \tconsistent{\htau_1}{\htau_1'}\\
  \tconsistent{\htau_2}{\htau_2'}
}{
  \tconsistent{\tsum{\htau_1}{\htau_2}}{\tsum{\htau_1'}{\htau_2'}}
}
\end{mathpar}

\judgbox{\arrmatch{\htau}{\tarr{\htau_1}{\htau_2}}}{$\htau$ has matched arrow type $\tarr{\htau_1}{\htau_2}$}
\begin{mathpar}
\inferrule{ }{
  \arrmatch{\tehole}{\tarr{\tehole}{\tehole}}
}

\inferrule{ }{
  \arrmatch{\tarr{\htau_1}{\htau_2}}{\tarr{\htau_1}{\htau_2}}
}
\end{mathpar}

\judgbox{\prodmatch{\htau}{\tprod{\htau_1}{\htau_2}}}{$\htau$ has matched product type $\tarr{\htau_1}{\htau_2}$}
\begin{mathpar}
\inferrule{ }{
  \prodmatch{\tehole}{\tprod{\tehole}{\tehole}}
}

\inferrule{ }{
  \prodmatch{\tprod{\htau_1}{\htau_2}}{\tprod{\htau_1}{\htau_2}}
}
\end{mathpar}

\judgbox{\summatch{\htau}{\tsum{\htau_1}{\htau_2}}}{$\htau$ has matched sum type $\tsum{\htau_1}{\htau_2}$}
\begin{mathpar}
\inferrule{ }{
  \summatch{\tehole}{\tsum{\tehole}{\tehole}}
}

\inferrule{ }{
  \summatch{\tsum{\htau_1}{\htau_2}}{\tsum{\htau_1}{\htau_2}}
}
\end{mathpar}
\caption{Type Consistency and Matched Types}
\label{fig:tconsistent}
\label{fig:arrmatch}
\end{figure}

\begin{figure}[h]
\judgbox{\expandSyn{\hGamma}{\hexp}{\dexp}{\htau}{\Delta}}{ }
\begin{mathpar}
(var)

(ap)

(num)

(plus)

(empty hole)

(non-empty hole)

(asc)
\end{mathpar}

\judgbox{\expandAna{\hGamma}{\hexp}{\dexp}{\htau}{\Delta}}{ }
\begin{mathpar}
(lam)

(subsumption)
\end{mathpar}
\caption{Algorithmic Expansion}
\label{fig:expandSyn}
\label{fig:expandAna}
\end{figure}

\begin{figure}[h!]
\judgbox{\hasType{\hGamma}{\dexp}{\htau}{\Delta}}{$\dexp$ has type $\htau$ with holes $\Delta$}
\begin{mathpar}
\inferrule[decl-var]{
	\tconsistent{\htau}{\htau'}
}{
	\hasType{\hGamma, x : \htau}{x}{\htau'}{\emptyset}
}

\inferrule[decl-abs]{
	a
}{
	\hasType{\hGamma}{\hlam{x}{\dexp}}{\htau}{\Delta}
}
(ap)

(num)

(plus)

(empty hole)

(non-empty hole)
\end{mathpar}
\caption{Declarative Statics}
\label{fig:hasType}
\end{figure}

\begin{figure}[h!]
\judgbox{[\dexp_1 / x] \dexp_2 = \dexp_3}{Substitution}
\[
\begin{array}{lcl}
[\dexp_1 / x] \dehole{\mvar}{\subst}
&=&
\dehole{\mvar}{[\dexp_1 / x] \cdot \subst}
\\
{[\dexp_1 / x] \dhole{\dexp_2}{\mvar}{\subst}}
&=& 
\dhole{ [ \dexp_1 / x ] \dexp_2 }{\mvar}{[\dexp_1 / x] \subst}
\\
{[\dexp_1 / x] \dlam{y}{\dexp_2}}
&=&
{\dlam{y}{[\dexp_1 / x] \dexp_2}}
\\
{[\dexp_1 / x] \dapP{e_2}{e_3}}
&=&
{\dapP{[\dexp_1 / x] e_2}{[\dexp_1 / x] e_3}}
\\
{[\dexp_1 / x] \dinj{i}{e_2}}
&=&
{\dinj{i}{[\dexp_1 / x] e_2}}
\\
{[\dexp_1 / x] \dcase{e}{x}{e_x}{y}{e_y}}
&=&
{\dcase{[\dexp_1 / x]e}{x}{[\dexp_1 / x]e_x}{y}{[\dexp_1 / x]e_y}}
\\
{[\dexp_1 / x] \dnum{n}}
&=&
{\dnum{n}}
\\
{[\dexp_1 / x] \dadd{e_2}{e_3}}
&=&
{\dadd{[\dexp_1 / x] e_2}{[\dexp_1 / x] e_3}}
\end{array}
\]
\end{figure}

\begin{figure}
\judgbox{\isValue{\dexp}}{$\dexp$ is a value}
\begin{mathpar}
\Infer{v-lam}
{ }{\isValue{\hlam{x}{\dexp}}}
\and
\Infer{v-num}
{ }{\isValue{\hnum{n}}}
\and
\Infer{v-inj}
{\isValue{\dexp}}{\isValue{\hinj{i}{\dexp}}}
\end{mathpar}

\judgbox{\isIndet{\dexp}}{$\dexp$ is indeterminate}
\begin{mathpar}
\Infer{i-ehole}
{ }
{\isIndet{\dehole{\mvar}{\subst}}}
\and
\Infer{i-hole}
{\isFinal{\dexp}}
{\isIndet{\dhole{\dexp}{\mvar}{\subst}}}
\\
\Infer{i-add$_1$}
{\isIndet{\dexp_1} \\ \isFinal{\dexp_2}}
{\isIndet{\dadd{\dexp_1}{\dexp_2}}}
\and
\Infer{i-add$_2$}
{\isFinal{\dexp_1} \\ \isIndet{\dexp_2}}
{\isIndet{\dadd{\dexp_1}{\dexp_2}}}
\and
\Infer{i-app}
{\isIndet{\dexp_1}}
{\isIndet{\dap{\dexp_1}{\dexp_2}}}
\and
\Infer{i-case}
{\isIndet{\dexp}}
{\isIndet{\dcase{\dexp}{x}{\dexp_x}{y}{\dexp_y}}}
\end{mathpar}

\judgbox{\isErr{\dexp}}{$\dexp$ is error}
\begin{mathpar}
\Infer{e-cast}
% XXX use macro type assignment judgement here
{ \vdash e : \htau_2 \\ \tinconsistent{\htau_1}{\htau_2}}
{\isErr{\dcast{\dexp}{\htau_1}}}
\and
\Infer{e-add$_1$}
{\isErr{\dexp_1}}
{\isErr{\dadd{\dexp_1}{\dexp_2}}}
\and
\Infer{e-add$_2$}
{\isErr{\dexp_2}}
{\isErr{\dadd{\dexp_1}{\dexp_2}}}
\and
\Infer{e-app}
{\isErr{\dexp_1}}
{\isErr{\dap{\dexp_1}{\dexp_2}}}
\and
\Infer{e-case}
{\isErr{\dexp}}
{\isErr{\dcase{\dexp}{x}{\dexp_x}{y}{\dexp_y}}}
\end{mathpar}

\judgbox{\isValue{\dexp}}{$\dexp$ is a value}
\begin{mathpar}
\Infer{f-val}
{\isValue{\dexp}}{\isFinal{\dexp}}
\and
\Infer{f-indet}
{\isIndet{\dexp}}{\isFinal{\dexp}}
\and
\Infer{f-err}
{\isErr{\dexp}}{\isFinal{\dexp}}
\end{mathpar}

\judgbox{\stepsTo{\dexp_1}{\dexp_2}}{$\dexp_1$ steps to $\dexp_2$}
\begin{mathpar}
\Infer{s-hole}
{\stepsTo{\dexp_1}{\dexp_2} }
{\stepsTo{\dhole{\dexp_1}{\mvar}{\subst}}{\dhole{\dexp_2}{\mvar}{\subst}}}
\and
\Infer{s-cast}
% XXX use macro type assignment judgement here
{ \vdash e : \htau_2 \\ \tconsistent{\htau_1}{\htau_2}}
{\stepsTo{\dcast{\dexp}{\htau_1}}{\dexp}}
\\
\Infer{s-add$_1$}
{\stepsTo{\dexp_1}{\dexp_1'}}
{\stepsTo{\dadd{\dexp_1}{\dexp_2}}{\dadd{\dexp_1'}{\dexp_2}}}
\and
\Infer{s-add$_2$}
{\isFinal{\dexp_1} \\ \stepsTo{\dexp_2}{\dexp_2'}}
{\stepsTo{\dadd{\dexp_1}{\dexp_2}}{\dadd{\dexp_1}{\dexp_2'}}}
\and
\Infer{s-add$_3$}
{ n_1 + n_2 = n_3 }
{\stepsTo{\dadd{\dnum{n_1}}{\dnum{n_2}}}{\dnum{n_3}}}
%\and
\\
\Infer{s-app$_1$}
{\stepsTo{\dexp_1}{\dexp_1'}}
{\stepsTo{\dap{\dexp_1}{\dexp_2}}{\dap{\dexp_1'}{\dexp_2}}}
\and
\Infer{s-app$_2$}
{ \isFinal{\dexp_1} \\ \stepsTo{\dexp_2}{\dexp_2'}}
{\stepsTo{\dap{\dexp_1}{\dexp_2}}{\dap{\dexp_1}{\dexp_2'}}}
\and
\Infer{s-app$_\beta$}
{ \isFinal{\dexp_2} }
{\stepsTo{\dapP{\dlam{x}{\dexp_1}}{\dexp_2}}{ [\dexp_2/x]\dexp_1 }}
%\and
\\
\Infer{s-case$_1$}
{\stepsTo{\dexp}{\dexp'}}
{\stepsTo{\dcase{\dexp}{x}{\dexp_x}{y}{\dexp_y}}{\dcase{\dexp'}{x}{\dexp_x}{y}{\dexp_y}}}
\and
\Infer{s-case$_2$}
{ }
{\stepsTo{\dcase{\dinj{1}{\dexp}}{x}{\dexp_x}{y}{\dexp_y}}{ [\dexp/x]\dexp_x }}
\and
\Infer{s-case$_3$}
{ }
{\stepsTo{\dcase{\dinj{2}{\dexp}}{x}{\dexp_x}{y}{\dexp_y}}{ [\dexp/y]\dexp_y }}
\end{mathpar}
\caption{Structural Dynamics}
\label{fig:isValue}
\label{fig:isIndet}
\label{fig:stepsTo}
\end{figure}
