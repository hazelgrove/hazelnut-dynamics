% !TEX root = hazelnut-dynamics.tex

\clearpage
\newcommand{\calculusSec}{Hazelnut Live, Formally}
\section{\protect\calculusSec}
\label{sec:calculus}
\cy{exposition}

\subsection{Calculus}

\subsubsection{Syntax}

\input{fig-syntax}

{\color{gray}\blindtext}

Shorthand:

$$
\dcastthree{\dexp}{\htau_1}{\htau_2}{\htau_3} \defeq
  \dcasttwo{\dcasttwo{\dexp}{\htau_1}{\htau_2}}{\htau_2}{\htau_3}
$$

Explain that $c$ is a placeholder constant (i.e., unit), $b$ is a placeholder
type (i.e., unit).



\subsubsection{Statics}

\input{fig-type-consistency}
\input{fig-bidirectional-typing}

{\color{gray}\blindtext}
{\color{gray}\blindtext}
{\color{gray}\blindtext}

A typing context, $\hGamma$, is a list of bindings $x : \htau$.

\subsubsection{Expansion}

\input{fig-expansion}
\input{fig-typing-dexp}

{\color{gray}\blindtext}
{\color{gray}\blindtext}
{\color{gray}\blindtext}

A hole context, $\hDelta$, is a list of bindings $\Dbinding{u}{\hGamma}{\htau}$.

\subsubsection{Dynamics}

\input{fig-substitution}
\input{fig-dynamics-aux}
\input{fig-dynamics-steps}
\input{fig-dynamics-contexts}

{\color{gray}\blindtext}
{\color{gray}\blindtext}
{\color{gray}\blindtext}
{\color{gray}\blindtext}
{\color{gray}\blindtext}

\subsubsection{Examples}




\cy{definition of complete types and terms? do we care about completeness
  of $\hexp$s or $\dexp$s?}


%% \begin{figure}[!ht]
%%   \begin{definition}
%%     $\hasType{\Delta}{\hGamma}{\sigma}{\hGamma'}$ iff for each $\dexp/x \in \sigma$, we have $x : \htau \in \hGamma'$ and $\hasType{\Delta}{\hGamma}{\dexp}{\htau}$.
%%   \end{definition}
%%   \caption{substitution type assignment}
%%   \label{fig:subassign}
%% \end{figure}


%% \begin{figure}[!ht]
  \begin{definition}
    $\hasType{\Delta}{\hGamma}{\sigma}{\hGamma'}$ iff $\domof{\sigma} = \domof{\Gamma'}$ and for each $\dexp/x \in \sigma$, we have $x : \htau \in \hGamma'$ and $\hasType{\Delta}{\hGamma}{\dexp}{\htau}$.
  \end{definition}
%%   \caption{substitution type assignment}
%% \end{figure}





%%   \halam{x}{\htau}{\evalctx} ~\vert~



\clearpage
\subsection{Metatheory \rkc{TODO}}

(these theorems should be taken as fairly provisional)

\begin{theorem}[Expandability \cy{??}] ~
  \begin{enumerate}
    \item If $\hsyn{\hGamma}{\hexp}{\htau}$ then $\expandSyn{\hGamma}{\hexp}{\htau}{\dexp}{\Delta}$ for some $\dexp$ and $\Delta$.
    \item If $\hana{\hGamma}{\hexp}{\htau}$ then $\expandAna{\hGamma}{\hexp}{\htau}{\dexp}{\htau'}{\Delta}$ for some $\dexp$ and $\htau'$ and $\Delta$.
  \end{enumerate}
\end{theorem}

\begin{theorem}[Correspondence \cy{??}] ~
  \begin{enumerate}
    \item If $\expandSyn{\hGamma}{\hexp}{\htau}{\dexp}{\Delta}$ then $\hsyn{\hGamma}{\hexp}{\htau}$.
    \item If $\expandAna{\hGamma}{\hexp}{\htau}{\dexp}{\htau'}{\Delta}$ then $\hana{\hGamma}{\hexp}{\htau}$.
  \end{enumerate}
\end{theorem}

\begin{theorem}[Typed Expansion] ~
  \begin{enumerate}
    \item If $\expandSyn{\hGamma}{\hexp}{\htau}{\dexp}{\Delta}$ then $\hasType{\Delta}{\hGamma}{\dexp}{\htau}$.
    \item If $\expandAna{\hGamma}{\hexp}{\htau}{\dexp}{\htau'}{\Delta}$ then $\tconsistent{\htau}{\htau'}$ and $\hasType{\Delta}{\hGamma}{\dexp}{\htau'}$.
  \end{enumerate}
\end{theorem}

\begin{theorem}[Expansion Unicity] ~
  \begin{enumerate}
    \item If $\expandSyn{\hGamma}{\hexp}{\htau}{\dexp}{\Delta}$ and $\expandSyn{\hGamma}{\hexp}{\htau'}{\dexp'}{\Delta'}$ then $\htau=\htau'$ and $\dexp=\dexp'$ and $\Delta=\Delta'$.
    \item If $\expandAna{\hGamma}{\hexp}{\htau_1}{\dexp}{\htau_2}{\Delta}$ and $\expandAna{\hGamma}{\hexp}{\htau_1}{\dexp'}{\htau_2'}{\Delta'}$ then $\dexp=\dexp'$ and $\htau_2=\htau_2'$ and $\Delta=\Delta'$.
  \end{enumerate}
\end{theorem}

\begin{theorem}[Type Assignment Unicity]
If $\hasType{\Delta}{\hGamma}{\dexp}{\htau}$ and $\hasType{\Delta}{\hGamma}{\dexp}{\htau'}$ then $\htau=\htau'$.
\end{theorem}

\begin{theorem}[Progress]
If $\hasType{\Delta}{\emptyset}{\dexp}{\htau}$ then either $\stepsToD{\Delta}{\dexp}{\dexp'}$ or 
$\isValue{\dexp}$ or $\isErr{\Delta}{\dexp}$ or $\isIndet{\dexp}$. 
% for some $\dexp'$.
\end{theorem}

\begin{theorem}[Preservation]
  If $\hasType{\Delta}{\emptyset}{\dexp}{\htau}$ and
  $\stepsToD{\Delta}{\dexp}{\dexp'}$ then
  $\hasType{\Delta}{\emptyset}{\dexp'}{\htau}$. \cy{or maybe up to
  consistency?}
\end{theorem}

\begin{theorem}[Complete Progress \cy{??}]
If $\hcomplete{\hexp}$ and
$\expandSyn{\emptyset}{\hexp}{\htau}{\dexp}{\Delta}$ then either
$\isValue{\dexp}$ or $\stepsToD{\Delta}{\dexp}{\dexp'}$ for some $\dexp'$.

\end{theorem}

\begin{theorem}[Complete Preservation \cy{??}]
If $\hcomplete{\hexp}$ and
$\expandSyn{\emptyset}{\hexp}{\htau}{\dexp}{\Delta}$ and
$\stepsToD{\Delta}{\dexp}{\dexp'}$ then
$\hasType{\Delta}{\emptyset}{\dexp'}{\htau}$
\end{theorem}

\begin{theorem}[Commutativity \cy{state this}]
\end{theorem}


\begin{theorem}[Maximum Informativity]
If the expansion produces $t1$, and there exists another possible type choice
$t2$, then $t1 \sim t2$ and $t1 JOIN t2 = t1$
\end{theorem}\footnote{idea is that special casing the holes in EANEHole gives you ``the
most descriptive hole types'' for some sense of what that means -- they'd
all just be hole other wise. from Matt:
\begin{quote}
It sounds like we need a something akin to an abstract domain (a lattice),
where hole has the least information, and a fully-defined type (without
holes) has the most information.  You can imagine that this lattice really
expands the existing definition we have of type consistency, which is
merely the predicate that says whether two types are comparable
(“join-able”) in this lattice.  lattice join is the operation that goes
through the structure of two (consistent) types, and chooses the structure
that is more defined (i.e., non-hole, if given the choice between hole and
non-hole).

The rule choosenonhole below is the expansion of this consistency rule that
we already have (hole consistent with everything)
\end{quote}}

\begin{verbatim}
t not hole
-------------------- :: choose-non-hole
hole JOIN t  = t
\end{verbatim}
\begin{verbatim}
------------ :: hole-consistent-with-everything
hole ~ t
\end{verbatim}

\cy{canonical forms}

\cy{indeterminate forms}
