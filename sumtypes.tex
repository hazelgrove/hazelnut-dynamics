%%%%%%% Syntax
We extend the syntax for sum types as follows:
\[
\begin{array}{rllllll}
\mathsf{HTyp} & \htau & ::= \cdots ~\vert~ {\htau + \htau} &
\\
\mathsf{HExp} & \hexp & ::= \cdots
~\vert~ \hinL{\hexp}
~\vert~ \hinR{\hexp}
%~\vert~ \hcase{\hexp}{\hinL{x}}{\hexp}{\hinR{x}}{\hexp}
~\vert~ \hcase{\hexp}{x}{\hexp}{y}{\hexp}
\\
\mathsf{IHExp} & \dexp & ::= \cdots
~\vert~ \dinL{\htau}{\dexp}
~\vert~ \dinR{\htau}{\dexp}
%~\vert~ \dcase{\dexp}{\hinL{x}}{\dexp}{\hinR{x}}{\dexp}
~\vert~ \dcase{\dexp}{x}{\dexp}{y}{\dexp}
\end{array}
\]

%%%%%%% Definition of Join: a meta-level, binary function over types.

%\newcommand{\JoinTypes}[2]{\textsf{join}~~#1~~#2}
\newcommand{\JoinTypes}[2]{\textsf{join}(#1,#2)}

%\fbox{$\JoinTypes{\htau_1}{\htau_2} = \htau_3$}
\judgbox
 {\JoinTypes{\htau_1}{\htau_2} = \htau_3}
 {Types~$\htau_1$ and $\htau_2$ join (consistently), forming type~$\htau_3$}
\[
\begin{array}{lcl}
\JoinTypes{\htau}{\htau} &=&  \htau
\\
\JoinTypes{\tehole}{\htau} &=&  \htau
\\
\JoinTypes{\htau}{\tehole} &=&  \htau
\\
\JoinTypes
{\tarr{\htau_1}{\htau_2}}
{\tarr{\htau_1}{\htau_2}}
&=&
\tarr{\JoinTypes{\htau_1}{\htau_2}}
     {\JoinTypes{\htau_1}{\htau_2}}
\\
\JoinTypes
{\tsum{\htau_1}{\htau_2}}
{\tsum{\htau_1}{\htau_2}}
&=&
\tsum{\JoinTypes{\htau_1}{\htau_2}}
     {\JoinTypes{\htau_1}{\htau_2}}
\end{array}
\]

\begin{thm}[Joins]
If $\JoinTypes{\tau_1}{\tau_2} = \tau$ 
%
then types $\tau_1$, $\tau_2$ and $\tau$ are pair-wise consistent, i.e.,
%
$\tconsistent{\tau_1}{\tau_2}$, 
$\tconsistent{\tau_1}{\tau}$ and 
$\tconsistent{\tau_2}{\tau}$.
\begin{proof}
By induction on the derivation of $\JoinTypes{\tau_1}{\tau_2} = \tau$.
\matt{Double-check this proof sketch}
\end{proof}
\end{thm}

%%%%%%% 
\vspace*{5mm}

\judgbox
 {\summatch{\htau}{\tsum{\htau_1}{\htau_2}}}
 {Type~$\htau$ matches the sum type~$\tsum{\htau_1}{\htau_2}$}
\begin{mathpar}
\inferrule[]{~}{\summatch{\tsum{\tau_1}{\tau_2}}{\tsum{\tau_1}{\tau_2}}}
\and
\inferrule[]{~}{\summatch{\tehole}{\tsum{\tehole}{\tehole}}}
\end{mathpar}

%%%%%%%%%%
\vspace*{5mm}

\judgbox
  {\expandAna{\hGamma}{\hexp}{\htau_1}{\dexp}{\htau_2}{\Delta}}
  {$\hexp$ analyzes against type $\htau_1$ and
   expands to $\dexp$ of consistent type $\htau_2$}
\begin{mathpar}
\inferrule[]{
  \summatch{\htau}{\tsum{\htau_1}{\htau_2}}
  \\
  \expandAna{\hGamma}{\hexp}{\htau_1}{\dexp}{\htau'_1}{\Delta}
}{
  \expandAna{\hGamma}{\hinL{\hexp}}{\htau}{\dinL{\tau_2}{\dexp}}{\tsum{\htau_1'}{\htau_2}}{\Delta}
}

\inferrule[]{
  \summatch{\htau}{\tsum{\htau_1}{\htau_2}}
  \\
  \expandAna{\hGamma}{\hexp}{\htau_2}{\dexp}{\htau'_2}{\Delta}
}{
  \expandAna{\hGamma}{\hinR{\hexp}}{\htau}{\dinL{\tau_1}{\dexp}}{\tsum{\htau_1}{\htau'_2}}{\Delta}
}

\inferrule[]{
  \expandSyn{\hGamma}{\hexp_1}{\htau_1}{\dexp_1}{\Delta_1}
  \\
  \summatch{\htau_1}{\tsum{\htau_{11}}{\htau_{12}}}
  \\
  \JoinTypes{\htau_2}{\htau_3} = {\htau'}
  \\
  \expandAna{\hGamma, x:\htau_{11}}{\hexp_2}{\htau}{\dexp_2}{\htau_2}{\Delta_2}
  \\
  \expandAna{\hGamma, y:\htau_{12}}{\hexp_3}{\htau}{\dexp_3}{\htau_3}{\Delta_3}
}{
  \expandAna{\hGamma}
            {\hcase{e_1}{x}{e_2}{y}{e_3}}
            {\htau}
            {\dcase
                {\dcasttwo{d_1}{\htau_1}{\tsum{\htau_{11}}{\htau_{12}}}}
                {x}{\dcasttwo{d_2}{\htau_2}{\htau'}}
                {y}{\dcasttwo{d_3}{\htau_3}{\htau'}}
            }
            {\htau'}
            {\Delta_1 \cup \Delta_2 \cup \Delta_3}
            }
\end{mathpar}

%% %%%%%%% 
